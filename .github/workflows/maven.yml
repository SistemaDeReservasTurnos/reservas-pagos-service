name: CI for Payment Service 

# El workflow se dispara en push/pull request a las ramas principales
on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
    types: [opened, synchronize, reopened]

jobs:
  build-and-test:
    # SRT-254: Definición del workflow y trigger (cumplido arriba)
    name: Build, Test, and Package
    runs-on: ubuntu-latest # Usa un corredor reciente de Ubuntu

    steps:
      # SRT-255: Configurar el paso para hacer checkout del código
      - name: Checkout Code
        uses: actions/checkout@v4

      # SRT-255: Configurar la versión de Java (Corretto 23)
      - name: Set up JDK 23 (Corretto)
        uses: actions/setup-java@v4
        with:
          java-version: '23'
          distribution: 'corretto'
          cache: 'maven' # Habilita el caché de dependencias de Maven

      # ------------------------------------------------------------------------
      # PASO 1: Compilación Rápida y Limpieza (Clean Install sin Tests)
      # ------------------------------------------------------------------------
      # SRT-256: Añadir el paso para ejecutar Maven clean install -DskipTests (solo compilar)
      - name: Maven Clean Install (Skip Tests)
        run: mvn clean install -DskipTests
        # Esto asegura que todas las dependencias se descarguen y se compile 
        # sin errores antes de la ejecución de las pruebas.

      # ------------------------------------------------------------------------
      # PASO 2: Ejecución de Pruebas y Reporte de Cobertura
      # ------------------------------------------------------------------------
      # SRT-257: Añadir paso para ejecutar pruebas con reportes de cobertura (Maven test)
      - name: Run Tests (SRT-151) and Generate Coverage Report
        run: mvn test
        # Las pruebas se ejecutan con el perfil de cobertura (si está configurado)

      # Opcional: Si usas JaCoCo, puedes subir el reporte de cobertura a Codecov o SonarCloud

      # ------------------------------------------------------------------------
      # PASO 3: Construcción Final del Artefacto
      # ------------------------------------------------------------------------
      # SRT-258: Añadir paso para construir y guardar el artefacto JAR
      - name: Package Executable JAR
        # Recompila (o usa el artifact existente) para asegurar que el JAR final se cree
        run: mvn package -DskipTests
        # Usamos package -DskipTests para generar el JAR ejecutable de forma limpia
      
      - name: Upload JAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: reservas-pagos-service-jar
          # Se asume que el JAR se llama 'reservas-pagos-service-0.0.1-SNAPSHOT.jar'
          # Puedes ajustar el nombre si usas otra convención.
          path: target/*.jar
          retention-days: 5
